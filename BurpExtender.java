package burp;

import burp.api.montoya.BurpExtension;
import burp.api.montoya.MontoyaApi;
import burp.api.montoya.core.ToolType;
import burp.api.montoya.http.message.HttpRequestResponse;
import burp.api.montoya.http.message.requests.HttpRequest;
import burp.api.montoya.http.message.responses.HttpResponse;
import burp.api.montoya.persistence.Preferences;
import burp.api.montoya.ui.Selection;
import burp.api.montoya.ui.UserInterface;
import burp.api.montoya.ui.contextmenu.ContextMenuEvent;
import burp.api.montoya.ui.contextmenu.ContextMenuItemsProvider;
import burp.api.montoya.ui.editor.HttpRequestEditor;
import burp.api.montoya.ui.editor.HttpResponseEditor;
import burp.api.montoya.ui.editor.EditorOptions;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import javax.swing.border.TitledBorder;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.nio.charset.StandardCharsets;
import java.util.Base64;
import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import java.lang.reflect.Type;

public class BurpExtender implements BurpExtension, ContextMenuItemsProvider {
    private static final String PERSISTENCE_KEY = "grouped_history_data";

    // ÂÆö‰πâÂõæÊ†áÂ∏∏Èáè
    private static final String ICON_ADD = "‚ûï";
    private static final String ICON_DELETE = "üóëÔ∏è";
    private static final String ICON_FOLDER = "üìÅ";
    private static final String ICON_FOLDER_OPEN = "üìÇ";
    private static final String ICON_REMOVE = "‚ùå";
    private static final String ICON_SEARCH = "üîç";
    private static final String ICON_EXPORT = "üì§";
    private static final String ICON_REFRESH = "üîÑ";

    // ÂÆö‰πâÈ¢úËâ≤Â∏∏Èáè
    private static final Color PRIMARY_COLOR = new Color(51, 122, 183);
    private static final Color DANGER_COLOR = new Color(217, 83, 79);
    private static final Color SUCCESS_COLOR = new Color(92, 184, 92);
    private static final Color BACKGROUND_COLOR = new Color(248, 249, 250);
    private static final Color SIDEBAR_COLOR = new Color(240, 240, 240);

    private MontoyaApi api;
    private JPanel mainPanel;
    private JPanel sidebarPanel;
    private JPanel groupListPanel;
    private String currentSelectedGroup;
    private DefaultListModel<HttpRequestResponse> requestListModel;
    private JList<HttpRequestResponse> requestList;
    private HttpRequestEditor requestEditor;
    private HttpResponseEditor responseEditor;
    private Map<String, List<HttpRequestResponse>> groupMap = new HashMap<>();
    private Map<String, JToggleButton> groupButtons = new HashMap<>();
    private JTextField searchField;
    private JLabel statusLabel;
    private ButtonGroup groupButtonGroup;
    private Gson gson;

    // Áî®‰∫éJSONÂ∫èÂàóÂåñÁöÑÊï∞ÊçÆÁ±ª
    private static class SerializableRequestResponse {
        public String request;
        public String response;

        public SerializableRequestResponse(String request, String response) {
            this.request = request;
            this.response = response;
        }
    }

    @Override
    public void initialize(MontoyaApi api) {
        this.api = api;
        this.gson = new Gson();
        api.extension().setName("Grouped History");
        api.userInterface().registerContextMenuItemsProvider(this);

        SwingUtilities.invokeLater(() -> {
            createUI();
            api.userInterface().registerSuiteTab("Grouped History", mainPanel);
            loadDataFromProject();
        });
    }

    private void createUI() {
        mainPanel = new JPanel(new BorderLayout());
        mainPanel.setBackground(BACKGROUND_COLOR);

        // ÂàõÂª∫Â∑¶‰æßËæπÊ†è
        createSidebar();

        // ÂàõÂª∫‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü
        createMainContentArea();

        // ÂàõÂª∫Áä∂ÊÄÅÊ†è
        createStatusBar();

        // ÁªÑË£ÖÊï¥‰ΩìÂ∏ÉÂ±Ä
        mainPanel.add(sidebarPanel, BorderLayout.WEST);

        // ÂàùÂßãÂåñ
        refreshAllGroupButtons();
    }

    private void createSidebar() {
        sidebarPanel = new JPanel(new BorderLayout());
        sidebarPanel.setBackground(SIDEBAR_COLOR);
        sidebarPanel.setPreferredSize(new Dimension(280, 0));
        sidebarPanel.setBorder(new EmptyBorder(10, 10, 10, 5));

        // ‰æßËæπÊ†èÊ†áÈ¢òÂíåÂ∑•ÂÖ∑Ê†è
        JPanel sidebarHeader = new JPanel(new BorderLayout());
        sidebarHeader.setBackground(SIDEBAR_COLOR);

        JLabel titleLabel = new JLabel("ÂàÜÁªÑÁÆ°ÁêÜ", SwingConstants.CENTER);
        titleLabel.setFont(titleLabel.getFont().deriveFont(Font.BOLD, 14f));
        titleLabel.setBorder(new EmptyBorder(5, 0, 15, 0));

        // Â∑•ÂÖ∑Ê†èÊåâÈíÆ
        JPanel toolbarPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 5, 0));
        toolbarPanel.setBackground(SIDEBAR_COLOR);

        JButton addGroupBtn = createStyledButton(ICON_ADD + " Êñ∞Âª∫", PRIMARY_COLOR);
        addGroupBtn.setToolTipText("ÂàõÂª∫Êñ∞ÂàÜÁªÑ");
        addGroupBtn.addActionListener(e -> showAddGroupDialog());

        JButton deleteGroupBtn = createStyledButton(ICON_DELETE + " Âà†Èô§", DANGER_COLOR);
        deleteGroupBtn.setToolTipText("Âà†Èô§ÂΩìÂâçÂàÜÁªÑ");
        deleteGroupBtn.addActionListener(e -> deleteCurrentGroup());

        JButton refreshBtn = createStyledButton(ICON_REFRESH, PRIMARY_COLOR);
        refreshBtn.setToolTipText("Âà∑Êñ∞ÂàóË°®");
        refreshBtn.addActionListener(e -> refreshRequestList());

        toolbarPanel.add(addGroupBtn);
        toolbarPanel.add(deleteGroupBtn);
        toolbarPanel.add(refreshBtn);

        sidebarHeader.add(titleLabel, BorderLayout.NORTH);
        sidebarHeader.add(toolbarPanel, BorderLayout.SOUTH);

        // ÊêúÁ¥¢Ê°Ü
        JPanel searchPanel = new JPanel(new BorderLayout(5, 0));
        searchPanel.setBackground(SIDEBAR_COLOR);
        searchPanel.setBorder(new EmptyBorder(10, 0, 10, 0));

        JLabel searchIcon = new JLabel(ICON_SEARCH);
        searchField = new JTextField();
        searchField.setToolTipText("ÊêúÁ¥¢ÂàÜÁªÑ...");
        searchField.addActionListener(e -> filterGroups());

        searchPanel.add(searchIcon, BorderLayout.WEST);
        searchPanel.add(searchField, BorderLayout.CENTER);

        // ÂàÜÁªÑÂàóË°®ÂÆπÂô®
        groupListPanel = new JPanel();
        groupListPanel.setLayout(new BoxLayout(groupListPanel, BoxLayout.Y_AXIS));
        groupListPanel.setBackground(SIDEBAR_COLOR);

        JScrollPane groupScrollPane = new JScrollPane(groupListPanel);
        groupScrollPane.setBorder(null);
        groupScrollPane.getVerticalScrollBar().setUnitIncrement(16);
        groupScrollPane.setBackground(SIDEBAR_COLOR);
        groupScrollPane.getViewport().setBackground(SIDEBAR_COLOR);

        sidebarPanel.add(sidebarHeader, BorderLayout.NORTH);
        sidebarPanel.add(searchPanel, BorderLayout.CENTER);
        sidebarPanel.add(groupScrollPane, BorderLayout.SOUTH);

        // ËÆ©ÂàÜÁªÑÊªöÂä®Èù¢ÊùøÂç†Áî®‰∏ªË¶ÅÁ©∫Èó¥
        sidebarPanel.remove(searchPanel);
        sidebarPanel.remove(groupScrollPane);

        JPanel centerPanel = new JPanel(new BorderLayout());
        centerPanel.setBackground(SIDEBAR_COLOR);
        centerPanel.add(searchPanel, BorderLayout.NORTH);
        centerPanel.add(groupScrollPane, BorderLayout.CENTER);

        sidebarPanel.add(centerPanel, BorderLayout.CENTER);
    }

    private void createMainContentArea() {
        JPanel contentPanel = new JPanel(new BorderLayout());
        contentPanel.setBorder(new EmptyBorder(10, 5, 10, 10));

        // ËØ∑Ê±ÇÂàóË°®Âå∫Âüü
        JPanel requestPanel = createRequestListPanel();

        // ÁºñËæëÂô®Âå∫Âüü
        JSplitPane editors = new JSplitPane(JSplitPane.VERTICAL_SPLIT);
        editors.setBorder(new TitledBorder("ËØ∑Ê±Ç/ÂìçÂ∫îËØ¶ÊÉÖ"));

        requestEditor = api.userInterface().createHttpRequestEditor(EditorOptions.READ_ONLY);
        responseEditor = api.userInterface().createHttpResponseEditor(EditorOptions.READ_ONLY);

        editors.setTopComponent(requestEditor.uiComponent());
        editors.setBottomComponent(responseEditor.uiComponent());
        editors.setResizeWeight(0.5);

        // ‰∏ªË¶ÅÂÜÖÂÆπÂàÜÂâ≤Èù¢Êùø
        JSplitPane mainSplitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, requestPanel, editors);
        mainSplitPane.setResizeWeight(0.4);

        contentPanel.add(mainSplitPane, BorderLayout.CENTER);
        mainPanel.add(contentPanel, BorderLayout.CENTER);
    }

    private JPanel createRequestListPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBorder(new TitledBorder("ËØ∑Ê±ÇÂàóË°®"));

        // ËØ∑Ê±ÇÂàóË°®Â∑•ÂÖ∑Ê†è
        JPanel listToolbar = new JPanel(new FlowLayout(FlowLayout.LEFT));

        JButton removeBtn = createStyledButton(ICON_REMOVE + " ÁßªÈô§ÈÄâ‰∏≠", DANGER_COLOR);
        removeBtn.setToolTipText("‰ªéÂΩìÂâçÂàÜÁªÑ‰∏≠ÁßªÈô§ÈÄâ‰∏≠ÁöÑËØ∑Ê±Ç");
        removeBtn.addActionListener(e -> removeSelectedRequestsFromCurrentGroup());

        JButton exportBtn = createStyledButton(ICON_EXPORT + " ÂØºÂá∫", PRIMARY_COLOR);
        exportBtn.setToolTipText("ÂØºÂá∫ÂΩìÂâçÂàÜÁªÑÁöÑËØ∑Ê±Ç");
        exportBtn.addActionListener(e -> exportCurrentGroup());

        listToolbar.add(removeBtn);
        listToolbar.add(exportBtn);

        // ËØ∑Ê±ÇÂàóË°®
        requestListModel = new DefaultListModel<>();
        requestList = new JList<>(requestListModel);
        requestList.setCellRenderer(new EnhancedRequestResponseCellRenderer());
        requestList.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);
        requestList.addListSelectionListener(e -> {
            if (!e.getValueIsAdjusting()) {
                HttpRequestResponse selected = requestList.getSelectedValue();
                if (selected != null) {
                    requestEditor.setRequest(selected.request());
                    if (selected.response() != null) {
                        responseEditor.setResponse(selected.response());
                    } else {
                        responseEditor.setResponse(HttpResponse.httpResponse(""));
                    }
                    updateStatusLabel();
                }
            }
        });

        // Âè≥ÈîÆËèúÂçï
        JPopupMenu requestListPopupMenu = new JPopupMenu();
        JMenuItem removeFromGroupItem = new JMenuItem(ICON_REMOVE + " ‰ªéÂàÜÁªÑ‰∏≠ÁßªÈô§");
        removeFromGroupItem.addActionListener(e -> removeSelectedRequestsFromCurrentGroup());
        requestListPopupMenu.add(removeFromGroupItem);
        requestList.setComponentPopupMenu(requestListPopupMenu);

        JScrollPane listScrollPane = new JScrollPane(requestList);
        listScrollPane.getVerticalScrollBar().setUnitIncrement(16);

        panel.add(listToolbar, BorderLayout.NORTH);
        panel.add(listScrollPane, BorderLayout.CENTER);

        return panel;
    }

    private void createStatusBar() {
        JPanel statusPanel = new JPanel(new BorderLayout());
        statusPanel.setBorder(new EmptyBorder(5, 10, 5, 10));
        statusPanel.setBackground(BACKGROUND_COLOR);

        statusLabel = new JLabel("Â∞±Áª™");
        statusLabel.setFont(statusLabel.getFont().deriveFont(Font.PLAIN, 12f));

        statusPanel.add(statusLabel, BorderLayout.WEST);
        mainPanel.add(statusPanel, BorderLayout.SOUTH);
    }

    private JButton createStyledButton(String text, Color backgroundColor) {
        JButton button = new JButton(text);
        button.setBackground(backgroundColor);
        button.setForeground(Color.WHITE);
        button.setFocusPainted(false);
        button.setBorderPainted(false);
        button.setFont(button.getFont().deriveFont(Font.BOLD, 12f));
        button.setCursor(new Cursor(Cursor.HAND_CURSOR));

        // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
        button.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseEntered(MouseEvent e) {
                button.setBackground(backgroundColor.darker());
            }

            @Override
            public void mouseExited(MouseEvent e) {
                button.setBackground(backgroundColor);
            }
        });

        return button;
    }

    private JToggleButton createGroupButton(String groupName) {
        String buttonText = ICON_FOLDER + " " + groupName;
        JToggleButton button = new JToggleButton(buttonText);
        button.setHorizontalAlignment(SwingConstants.LEFT);
        button.setMaximumSize(new Dimension(Integer.MAX_VALUE, 35));
        button.setPreferredSize(new Dimension(260, 35));
        button.setBackground(Color.WHITE);
        button.setBorder(new EmptyBorder(8, 12, 8, 12));
        button.setFont(button.getFont().deriveFont(Font.PLAIN, 12f));
        button.setCursor(new Cursor(Cursor.HAND_CURSOR));
        button.setFocusPainted(false);

        button.addActionListener(e -> {
            currentSelectedGroup = groupName;
            updateSelectedGroupButton(groupName);
            refreshRequestList();
            updateStatusLabel();
        });

        // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
        button.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseEntered(MouseEvent e) {
                if (!button.isSelected()) {
                    button.setBackground(new Color(230, 230, 230));
                }
            }

            @Override
            public void mouseExited(MouseEvent e) {
                if (!button.isSelected()) {
                    button.setBackground(Color.WHITE);
                }
            }
        });

        return button;
    }

    private void updateSelectedGroupButton(String selectedGroupName) {
        for (Map.Entry<String, JToggleButton> entry : groupButtons.entrySet()) {
            String groupName = entry.getKey();
            JToggleButton button = entry.getValue();

            boolean isSelected = groupName.equals(selectedGroupName);
            button.setSelected(isSelected);

            if (isSelected) {
                button.setText(ICON_FOLDER_OPEN + " " + groupName);
                button.setBackground(PRIMARY_COLOR);
                button.setForeground(Color.WHITE);
            } else {
                button.setText(ICON_FOLDER + " " + groupName);
                button.setBackground(Color.WHITE);
                button.setForeground(Color.BLACK);
            }
        }
    }

    private void showAddGroupDialog() {
        String groupName = JOptionPane.showInputDialog(mainPanel, "ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞Ôºö", "Êñ∞Âª∫ÂàÜÁªÑ", JOptionPane.PLAIN_MESSAGE);
        if (groupName != null && !groupName.trim().isEmpty() && !groupMap.containsKey(groupName)) {
            groupMap.put(groupName, new ArrayList<>());
            addGroupButton(groupName);
            currentSelectedGroup = groupName;
            updateSelectedGroupButton(groupName);
            refreshRequestList();
            saveDataToProject();
            updateStatusLabel();
            showStatusMessage("ÂàÜÁªÑ '" + groupName + "' ÂàõÂª∫ÊàêÂäü", SUCCESS_COLOR);
        }
    }

    private void deleteCurrentGroup() {
        if (currentSelectedGroup == null || groupMap.isEmpty()) {
            JOptionPane.showMessageDialog(mainPanel, "Ê≤°ÊúâÂèØÂà†Èô§ÁöÑÂàÜÁªÑ", "ÊèêÁ§∫", JOptionPane.INFORMATION_MESSAGE);
            return;
        }

        int requestCount = groupMap.get(currentSelectedGroup).size();
        int result = JOptionPane.showConfirmDialog(mainPanel,
                "Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁªÑ '" + currentSelectedGroup + "' ÂêóÔºü\nËøôÂ∞ÜÂà†Èô§ËØ•ÂàÜÁªÑ‰∏≠ÁöÑ " + requestCount + " ‰∏™ËØ∑Ê±Ç„ÄÇ",
                "Á°ÆËÆ§Âà†Èô§", JOptionPane.YES_NO_OPTION, JOptionPane.WARNING_MESSAGE);

        if (result == JOptionPane.YES_OPTION) {
            String deletedGroup = currentSelectedGroup;
            groupMap.remove(currentSelectedGroup);
            refreshAllGroupButtons();
            saveDataToProject();
            showStatusMessage("ÂàÜÁªÑ '" + deletedGroup + "' Â∑≤Âà†Èô§", SUCCESS_COLOR);
        }
    }

    private void addGroupButton(String groupName) {
        JToggleButton groupButton = createGroupButton(groupName);
        groupButtons.put(groupName, groupButton);
        groupListPanel.add(groupButton);
        groupListPanel.add(Box.createVerticalStrut(5));
        groupListPanel.revalidate();
        groupListPanel.repaint();
    }

    private void refreshAllGroupButtons() {
        groupListPanel.removeAll();
        groupButtons.clear();
        currentSelectedGroup = null;

        for (String groupName : groupMap.keySet()) {
            addGroupButton(groupName);
        }

        if (!groupMap.isEmpty()) {
            currentSelectedGroup = groupMap.keySet().iterator().next();
            updateSelectedGroupButton(currentSelectedGroup);
            refreshRequestList();
        } else {
            requestListModel.clear();
            showStatusMessage("ÊöÇÊó†ÂàÜÁªÑ", null);
        }

        groupListPanel.revalidate();
        groupListPanel.repaint();
    }

    private void refreshRequestList() {
        requestListModel.clear();
        if (currentSelectedGroup != null) {
            List<HttpRequestResponse> requests = groupMap.getOrDefault(currentSelectedGroup, new ArrayList<>());
            for (HttpRequestResponse item : requests) {
                requestListModel.addElement(item);
            }
        }
        updateStatusLabel();
    }

    private void updateStatusLabel() {
        if (currentSelectedGroup == null) {
            statusLabel.setText("Â∞±Áª™");
        } else {
            int totalRequests = groupMap.getOrDefault(currentSelectedGroup, new ArrayList<>()).size();
            int selectedRequests = requestList.getSelectedIndices().length;
            if (selectedRequests > 0) {
                statusLabel.setText("ÂàÜÁªÑ: " + currentSelectedGroup + " | ÊÄªÊï∞: " + totalRequests + " | Â∑≤ÈÄâÊã©: " + selectedRequests);
            } else {
                statusLabel.setText("ÂàÜÁªÑ: " + currentSelectedGroup + " | ÊÄªÊï∞: " + totalRequests + " ‰∏™ËØ∑Ê±Ç");
            }
        }
    }

    private void showStatusMessage(String message, Color color) {
        statusLabel.setText(message);
        if (color != null) {
            statusLabel.setForeground(color);
            // 3ÁßíÂêéÊÅ¢Â§çÈªòËÆ§Áä∂ÊÄÅ
            Timer timer = new Timer(3000, e -> {
                updateStatusLabel();
                statusLabel.setForeground(Color.BLACK);
            });
            timer.setRepeats(false);
            timer.start();
        }
    }

    private void filterGroups() {
        String searchText = searchField.getText().toLowerCase().trim();

        for (Map.Entry<String, JToggleButton> entry : groupButtons.entrySet()) {
            String groupName = entry.getKey();
            JToggleButton button = entry.getValue();
            boolean matches = searchText.isEmpty() || groupName.toLowerCase().contains(searchText);
            button.setVisible(matches);
        }

        groupListPanel.revalidate();
        groupListPanel.repaint();
    }

    private void removeSelectedRequestsFromCurrentGroup() {
        if (currentSelectedGroup == null) {
            JOptionPane.showMessageDialog(mainPanel, "ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂàÜÁªÑ", "ÊèêÁ§∫", JOptionPane.INFORMATION_MESSAGE);
            return;
        }

        List<HttpRequestResponse> selectedRequests = requestList.getSelectedValuesList();
        if (selectedRequests.isEmpty()) {
            JOptionPane.showMessageDialog(mainPanel, "ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁßªÈô§ÁöÑËØ∑Ê±Ç", "ÊèêÁ§∫", JOptionPane.INFORMATION_MESSAGE);
            return;
        }

        int result = JOptionPane.showConfirmDialog(mainPanel,
                "Á°ÆÂÆöË¶Å‰ªéÂàÜÁªÑ '" + currentSelectedGroup + "' ‰∏≠ÁßªÈô§ " + selectedRequests.size() + " ‰∏™ËØ∑Ê±ÇÂêóÔºü",
                "Á°ÆËÆ§ÁßªÈô§", JOptionPane.YES_NO_OPTION);

        if (result == JOptionPane.YES_OPTION) {
            List<HttpRequestResponse> groupList = groupMap.get(currentSelectedGroup);
            for (HttpRequestResponse request : selectedRequests) {
                groupList.remove(request);
            }
            refreshRequestList();
            saveDataToProject();
            showStatusMessage("Â∑≤ÁßªÈô§ " + selectedRequests.size() + " ‰∏™ËØ∑Ê±Ç", SUCCESS_COLOR);
        }
    }

    private void exportCurrentGroup() {
        if (currentSelectedGroup == null || groupMap.get(currentSelectedGroup).isEmpty()) {
            JOptionPane.showMessageDialog(mainPanel, "ÂΩìÂâçÂàÜÁªÑ‰∏∫Á©∫ÔºåÊó†Ê≥ïÂØºÂá∫", "ÊèêÁ§∫", JOptionPane.INFORMATION_MESSAGE);
            return;
        }

        // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÂØºÂá∫ÂäüËÉΩ
        showStatusMessage("ÂØºÂá∫ÂäüËÉΩÂºÄÂèë‰∏≠...", PRIMARY_COLOR);
    }

    @Override
    public List<Component> provideMenuItems(ContextMenuEvent event) {
        List<Component> menuItems = new ArrayList<>();

        if (event.selectedRequestResponses().size() > 0) {
            JMenuItem item = new JMenuItem(ICON_FOLDER + " ÂèëÈÄÅÂà∞ÂàÜÁªÑÂéÜÂè≤");
            item.addActionListener(e -> {
                List<HttpRequestResponse> messages = event.selectedRequestResponses();
                if (messages.isEmpty()) return;

                String[] groupNames = groupMap.keySet().toArray(new String[0]);
                String group = (String) JOptionPane.showInputDialog(
                        null,
                        "ÈÄâÊã©ÊàñËæìÂÖ•ÂàÜÁªÑÔºö",
                        "ÂèëÈÄÅÂà∞ÂàÜÁªÑ",
                        JOptionPane.PLAIN_MESSAGE,
                        null,
                        groupNames,
                        null
                );

                if (group != null && !group.trim().isEmpty()) {
                    groupMap.putIfAbsent(group, new ArrayList<>());
                    for (HttpRequestResponse message : messages) {
                        groupMap.get(group).add(message);
                    }

                    if (!groupButtons.containsKey(group)) {
                        addGroupButton(group);
                    }

                    currentSelectedGroup = group;
                    updateSelectedGroupButton(group);
                    refreshRequestList();
                    saveDataToProject();
                    showStatusMessage("Â∑≤Ê∑ªÂä† " + messages.size() + " ‰∏™ËØ∑Ê±ÇÂà∞ÂàÜÁªÑ '" + group + "'", SUCCESS_COLOR);
                }
            });
            menuItems.add(item);
        }

        return menuItems;
    }

    // ‰øÆÂ§çÁöÑ‰øùÂ≠òÊñπÊ≥ï - ‰ΩøÁî® Preferences API
    private void saveDataToProject() {
        try {
            Preferences preferences = api.persistence().preferences();
            Map<String, List<SerializableRequestResponse>> serializableData = new HashMap<>();

            for (Map.Entry<String, List<HttpRequestResponse>> entry : groupMap.entrySet()) {
                String groupName = entry.getKey();
                List<HttpRequestResponse> requests = entry.getValue();
                List<SerializableRequestResponse> serializableRequests = new ArrayList<>();

                for (HttpRequestResponse requestResponse : requests) {
                    String requestBase64 = null;
                    String responseBase64 = null;

                    if (requestResponse.request() != null) {
                        requestBase64 = Base64.getEncoder().encodeToString(
                                requestResponse.request().toByteArray().getBytes());
                    }

                    if (requestResponse.response() != null) {
                        responseBase64 = Base64.getEncoder().encodeToString(
                                requestResponse.response().toByteArray().getBytes());
                    }

                    serializableRequests.add(new SerializableRequestResponse(requestBase64, responseBase64));
                }

                serializableData.put(groupName, serializableRequests);
            }

            String jsonData = gson.toJson(serializableData);
            preferences.setString(PERSISTENCE_KEY, jsonData);

        } catch (Exception e) {
            api.logging().logToError("Failed to save grouped history data: " + e.getMessage());
        }
    }

    // ‰øÆÂ§çÁöÑÂä†ËΩΩÊñπÊ≥ï - ‰ΩøÁî® Preferences API
    private void loadDataFromProject() {
        try {
            Preferences preferences = api.persistence().preferences();
            String jsonData = preferences.getString(PERSISTENCE_KEY);

            if (jsonData == null || jsonData.trim().isEmpty()) {
                return;
            }

            Type type = new TypeToken<Map<String, List<SerializableRequestResponse>>>(){}.getType();
            Map<String, List<SerializableRequestResponse>> serializableData = gson.fromJson(jsonData, type);

            groupMap.clear();

            for (Map.Entry<String, List<SerializableRequestResponse>> entry : serializableData.entrySet()) {
                String groupName = entry.getKey();
                List<SerializableRequestResponse> serializableRequests = entry.getValue();
                List<HttpRequestResponse> requests = new ArrayList<>();

                for (SerializableRequestResponse serializableRequest : serializableRequests) {
                    try {
                        HttpRequest request = null;
                        HttpResponse response = null;

                        if (serializableRequest.request != null) {
                            byte[] requestBytes = Base64.getDecoder().decode(serializableRequest.request);
                            request = HttpRequest.httpRequest(new String(requestBytes, StandardCharsets.UTF_8));
                        }

                        if (serializableRequest.response != null) {
                            byte[] responseBytes = Base64.getDecoder().decode(serializableRequest.response);
                            response = HttpResponse.httpResponse(new String(responseBytes, StandardCharsets.UTF_8));
                        }

                        if (request != null) {
                            HttpRequestResponse requestResponse = HttpRequestResponse.httpRequestResponse(request, response);
                            requests.add(requestResponse);
                        }

                    } catch (Exception e) {
                        api.logging().logToError("Failed to load request from group " + groupName + ": " + e.getMessage());
                    }
                }

                if (!requests.isEmpty()) {
                    groupMap.put(groupName, requests);
                }
            }

            refreshAllGroupButtons();

        } catch (Exception e) {
            api.logging().logToError("Failed to load grouped history data: " + e.getMessage());
        }
    }

    // Â¢ûÂº∫ÁöÑËØ∑Ê±ÇÂìçÂ∫îÂçïÂÖÉÊ†ºÊ∏≤ÊüìÂô®
    private static class EnhancedRequestResponseCellRenderer extends DefaultListCellRenderer {
        @Override
        public Component getListCellRendererComponent(JList<?> list, Object value, int index, boolean isSelected, boolean cellHasFocus) {
            super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);

            if (value instanceof HttpRequestResponse) {
                HttpRequestResponse message = (HttpRequestResponse) value;
                HttpRequest request = message.request();
                HttpResponse response = message.response();

                String method = request.method();
                String path = request.path();
                if (request.query() != null && !request.query().isEmpty()) {
                    path += "?" + request.query();
                }

                String status = "";
                if (response != null) {
                    status = " [" + response.statusCode() + "]";
                }

                setText(method + " " + path + status);

                // Ê†πÊçÆHTTPÊñπÊ≥ïËÆæÁΩÆÂõæÊ†á
                String methodIcon = getMethodIcon(method);
                setText(methodIcon + " " + getText());

                // Ê†πÊçÆÁä∂ÊÄÅÁ†ÅËÆæÁΩÆÈ¢úËâ≤
                if (response != null) {
                    int statusCode = response.statusCode();
                    if (statusCode >= 200 && statusCode < 300) {
                        setForeground(isSelected ? Color.WHITE : new Color(0, 128, 0));
                    } else if (statusCode >= 400) {
                        setForeground(isSelected ? Color.WHITE : new Color(220, 20, 60));
                    }
                }

                setBorder(new EmptyBorder(5, 10, 5, 10));
            }
            return this;
        }

        private String getMethodIcon(String method) {
            switch (method.toUpperCase()) {
                case "GET": return "üìÑ";
                case "POST": return "üìù";
                case "PUT": return "‚úèÔ∏è";
                case "DELETE": return "üóëÔ∏è";
                case "PATCH": return "üîß";
                default: return "üìã";
            }
        }
    }
}
